<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #container {
            position: relative;
            width: 700px;
            height: 300px;
            border: 1px solid black;
            background-image: url("mario-background_4x.jpg");
            background-size: cover;
            background-position-y: -220px;

            animation: slide 5s linear infinite;
        }

        @keyframes slide {
            0% {
                background-position: 0 -220px;
            }

            100% {
                background-position: -700px -220px;
                /* 이미지가 이동하는 거리 */
            }
        }

        #character {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 0, 0, 0);
            position: absolute;
            bottom: 48px;
            /* 원래 0인데 48로 바뀜. 이에 맞춰 여러가지 전부 바꾸는 작업 수행중*/
            left: 30px;
        }

        #character img {
            position: relative;
            top: 5px;
            width: 100%;
            height: 100%;
        }

        .enemy {
            position: absolute;
            bottom: 58px;
            /**/
            left: 700px;
            width: 30px;
            height: 30px;
            background-color: rgba(0, 0, 255, 0);
        }

        .enemy img {
            width: 100%;
            border: 1px solid rgba(0, 0, 255, 0);

        }

        #point {
            margin-top: 30px;
            text-align: center;
        }

        .attack img {
            transform: scaleX(-1);
            width: 200%;
            height: 100%;
        }
    </style>
    <script>

        //setInterval(function () {}, 20);

        let point = 200;
        const GROUND_HEIGHT = 48

        function init() {
            const character = document.getElementById('character');
            let currentPosition = GROUND_HEIGHT; // 시작높이

            /**
             * 점프 함수
             * 
             * 점프 시작 후 중력가속도로 속도 감소 -> 하락
             * 
             * 다시 땅에 닿으면 함수 종료
             **/
            // 관련 변수
            let isJumping = false;
            //
            function jump() {
                let gravity = 1;
                let jumpSpeed = 15;

                let jumpInterval = setInterval(function () {
                    isJumping = true;

                    jumpSpeed -= gravity;

                    currentPosition += jumpSpeed;
                    character.style.bottom = currentPosition + 'px';

                    if (currentPosition <= GROUND_HEIGHT) {
                        clearInterval(jumpInterval);
                        isJumping = false;
                    }
                }, 20);
            }

            /**
             * 공격 생성 함수
             * 
             * 실행시 공격 이동함수 실행
             * 
             **/
            //관련 변수
            let isAttacking = false; // 연속실행방지
            let AttackCnt = 0; // 화면에 존재하는 공격 수. 오류방지 및 함수 종료용
            //
            function characterAttack() {
                AttackCnt++;
                // console.log(AttackCnt);

                isFirstAttack = true;
                isAttacking = true;

                const attack = document.createElement('div');
                attack.classList.add("attack");
                attack.style.width = "30px";
                attack.style.height = "30px";
                attack.style.position = "absolute";
                attack.style.left = "40px";
                attack.style.bottom = Math.floor(50) + 'px';
                attack.innerHTML = `<img src="https://i.namu.wiki/i/lWR9AkNAirXjG3JdYNFkrRUUvvc0QixiIqkP4pq2CfoIDGFRUwaHtsAnziZkr_TDFs0yBSUqv3bPTAssH4usrGEhFjEhGfA9VM_pwD0KKzL_hn2eMQdf-Rg2ZRSVCBqY8pKytZLrx0ds9ucfsEX1aA.webp"
                alt="">`

                document.getElementById('container').appendChild(attack);
                console.log("attack");

                // 공격 이동
                moveAttack(attack)

                setTimeout(function () {
                    isAttacking = false;
                }, 100);
            }

            /**
             * 공격 이동 함수
             * 
             * 화면에 공격 있을때만 실행
             */
            function moveAttack(attack) {
                let attackMoveInterval = setInterval(function () {
                    let attackLeft = parseInt(window.getComputedStyle(attack).getPropertyValue('left'));
                    console.log('move');
                    if (attackLeft > 650) {
                        --AttackCnt;
                        attack.remove();
                        console.log(AttackCnt);
                    }

                    attack.style.left = attackLeft + 10 + 'px';

                    if (AttackCnt < 1) {
                        clearInterval(attackMoveInterval);
                    }
                }, 20)
            }


            /**
             * 적 생성 및 캐릭터, 적, 공격 상호작용
             * 
             * 
             **/
            function createEnemy() {

                // 적 생성부
                const enemy = document.createElement('div');
                enemy.innerHTML = `<img src="https://static.wikia.nocookie.net/stabyourself/images/7/71/Anigoomba.gif/revision/latest/thumbnail/width/360/height/360?cb=20150107031425"
                alt="">`
                enemy.classList.add('enemy');
                enemy.style.width = '30px';
                enemy.style.height = '30px';
                enemy.style.position = 'absolute';
                enemy.style.left = '700px';
                //enemy.style.bottom = Math.floor(Math.random() * 250) + 'px'; // 랜덤한 높이에 위치
                enemy.style.bottom = Math.floor(GROUND_HEIGHT) + 'px';

                // 적 속성 불러오기
                document.getElementById('container').appendChild(enemy);
                let moveLeftInterval = setInterval(function () {
                    let enemyLeft = parseInt(window.getComputedStyle(enemy).getPropertyValue('left'));
                    let enemyBottom = parseInt(window.getComputedStyle(enemy).getPropertyValue('bottom'));
                    let pointBox = document.getElementById("point");

                    // 히트박스 정의
                    let characterHitboxTop = enemyBottom - currentPosition;
                    let enemyHitboxTop = currentPosition - enemyBottom;

                    // 캐릭터, 적 상호작용부
                    // 적이 끝까지 가면 적 삭제하고 점수 up
                    if (enemyLeft <= 0) {
                        enemy.remove();
                        clearInterval(moveLeftInterval);
                        point += 100;
                        pointBox.innerText = "점수 : " + point;

                    } else if (enemyLeft > 40 && enemyLeft <= 60 && (characterHitboxTop <= 50 && enemyHitboxTop <= 25)) { // 캐릭터, 적 충돌 감지
                        // 히트박스 좌측 좌표 // 히트박스 오른쪽 좌표 // 캐릭터 히트박스 상단(숫자) // 적 히트박스 상단(숫자)

                        clearInterval(moveLeftInterval);
                        alert("마리오가 죽었습니다!");
                        document.location.reload();

                    } else { // 적 이동
                        enemy.style.left = enemyLeft - 5 + 'px';
                    }

                    // 공격, 적 상호작용부
                    if (AttackCnt > 0) { // 화면에 공격이 존재할때
                        let attackList = document.getElementsByClassName('attack');
                        let attackLeft = parseInt(window.getComputedStyle(attackList[0]).getPropertyValue('left'));

                        if (enemyLeft < attackLeft + 50) {
                            enemy.remove();
                            attackList[0].remove();
                            AttackCnt--; // 적과 충돌시 공격도 사라진다.
                        }
                    }

                    // 이동속도 생성
                }, 20 + Math.floor(Math.random() * 5)); // 랜덤한 간격으로 이동


                setTimeout(createEnemy, 500 + Math.floor(Math.random() * 2500)); // 랜덤한 간격으로 생성
                // 재귀함수지만 별개의 스레드를 사용하기 때문에 실행스택이 쌓이지 않는다. (새로 실행된 함수의 실행여부와 상관없이 함수가 끝난다.)
            }

            // 함수 최초실행
            createEnemy();

            /**
             * 키 입력 감지 함수
             **/
            document.addEventListener('keydown', function (event) {
                if (event.code === 'Space' && !isJumping) {
                    jump();
                }
                if (event.code === 'KeyD' && !isAttacking && point >= 200) {
                    point -= 200;
                    document.getElementById("point").innerText = "점수 : " + point;
                    characterAttack();
                }
            });
        }
    </script>
</head>

<body onload="init()">
    <div id="container">
        <p id="point" style="color:white; text-shadow: 0px 0px 2px #000000;">점수 : 0</p>
        <div id="character">
            <img src="https://lh4.googleusercontent.com/LBfp4_egRNgUy3QI9FAiuaJRat9Hv4CckTeW5418KLaavhp5ftaYNmsKMCj2P3_feG3ZrfETzkrx-avrB3Lb9RLUvI5eYhr9n4Gg9WZ_uOdJa3nsHrQI-OoDZUyUKG9-0NyUAE7alXChirJ-Zw=s2048"
                alt="">
        </div>
    </div>
    <div>
        점프 : SPACE 공격 : D (200점 사용)
    </div>
</body>

</html>